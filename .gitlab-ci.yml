variables:
  exe7z: 'C:\Tools\7z\7za.exe'
  releaseDir: 'C:\Production'
  deployDir: 'MAKET\SpaceHub\WebMap'
  gitlabPath: 'gitlab.intecracy.com/DZVIN/WebMap.git'
  push_version: 'gitlab.intecracy.com/DZVIN/install_update.git'

stages:
  - build
  - deploy
  - increment-dzvin

.base: &base-dev
  only:
    - develop
  tags:
    - webmap-dev

.base: &base
  only:
    - master
  tags:
    - webmap-dev

build:
  stage: build
  <<: *base-dev
  before_script:
    - C:\Production\Version\curl-win\bin\curl.exe -s -X POST %TELEGRAM_URL% -d chat_id=%CHAT_ID% -d text="Pipe Start %CI_PROJECT_NAME% with %CI_COMMIT_MESSAGE% by %GITLAB_USER_LOGIN% on %CI_COMMIT_REF_NAME%"
  script:
    - echo Building project...
#    -  call npm i
#    - call npm install
    - call yarn --network-concurrency 1
    - call yarn add @DZVIN/CommonComponents @DZVIN/MilSymbolEditor --network-concurrency 1
    - copy .env .env.backup
    - copy .env.production .env
    - call npm run-script build
    - rmdir /s /q build\explorerLite
    - copy .env.backup .env
    - del .env.backup
    - set jsonfile=package.json
    - set psCmd="add-type -As System.Web.Extensions;$JSON = new-object Web.Script.Serialization.JavaScriptSerializer;$JSON.DeserializeObject($input).version"
    - for /f %%I in ('^<"%jsonfile%" powershell -noprofile %psCmd%') do set "version=%%I"
    - git status
    - git commit -a -m "[CI skip] %version% (autocommit)"
    - git push https://%PUSH_USER%:%PUSH_TOKEN%@%gitlabPath% HEAD:develop
    - echo Done
  after_script:
    - C:\Production\Version\curl-win\bin\curl.exe -s -X POST %TELEGRAM_URL% -d chat_id=%CHAT_ID% -d text=" %CI_PROJECT_NAME% %CI_JOB_NAME% Success"
  artifacts:
    expire_in: 1 hour
    paths:
      - ./build/index.html
      - ./build/manifest.json
      - ./build/favicon.ico
      - ./build/service-worker.js
      - ./build/asset-manifest.json
      - ./build/images/*.*
      - ./build/static/css/*.*
      - ./build/static/js/*.*
      - ./build/static/media/*.*
      - ./build/cesium/*.*
      - ./build/cesium/Assets/*.*
      - ./build/cesium/Assets/IAU2006_XYS/*.*
      - ./build/cesium/Assets/Images/*.*
      - ./build/cesium/Assets/Textures/*.*
      - ./build/cesium/Assets/Textures/LensFlare/*.*
      - ./build/cesium/Assets/Textures/maki/*.*
      - ./build/cesium/Assets/Textures/NaturalEarthII/*.*
      - ./build/cesium/Assets/Textures/NaturalEarthII/0/*.*
      - ./build/cesium/Assets/Textures/NaturalEarthII/0/0/*.*
      - ./build/cesium/Assets/Textures/NaturalEarthII/0/1/*.*
      - ./build/cesium/Assets/Textures/NaturalEarthII/1/*.*
      - ./build/cesium/Assets/Textures/NaturalEarthII/1/0/*.*
      - ./build/cesium/Assets/Textures/NaturalEarthII/1/1/*.*
      - ./build/cesium/Assets/Textures/NaturalEarthII/1/2/*.*
      - ./build/cesium/Assets/Textures/NaturalEarthII/1/3/*.*
      - ./build/cesium/Assets/Textures/NaturalEarthII/2/*.*
      - ./build/cesium/Assets/Textures/NaturalEarthII/2/0/*.*
      - ./build/cesium/Assets/Textures/NaturalEarthII/2/1/*.*
      - ./build/cesium/Assets/Textures/NaturalEarthII/2/2/*.*
      - ./build/cesium/Assets/Textures/NaturalEarthII/2/3/*.*
      - ./build/cesium/Assets/Textures/NaturalEarthII/2/4/*.*
      - ./build/cesium/Assets/Textures/NaturalEarthII/2/5/*.*
      - ./build/cesium/Assets/Textures/NaturalEarthII/2/6/*.*
      - ./build/cesium/Assets/Textures/NaturalEarthII/2/7/*.*
      - ./build/cesium/Assets/Textures/SkyBox/*.*
      - ./build/cesium/ThirdParty/*.*
      - ./build/cesium/ThirdParty/Workers/*.*
      - ./build/cesium/Widgets/*.*
      - ./build/cesium/Widgets/Animation/*.*
      - ./build/cesium/Widgets/BaseLayerPicker/*.*
      - ./build/cesium/Widgets/Cesium3DTilesInspector/*.*
      - ./build/cesium/Widgets/CesiumInspector/*.*
      - ./build/cesium/Widgets/CesiumWidget/*.*
      - ./build/cesium/Widgets/FullscreenButton/*.*
      - ./build/cesium/Widgets/Geocoder/*.*
      - ./build/cesium/Widgets/Images/*.*
      - ./build/cesium/Widgets/Images/ImageryProviders/*.*
      - ./build/cesium/Widgets/Images/NavigationHelp/*.*
      - ./build/cesium/Widgets/Images/TerrainProviders/*.*
      - ./build/cesium/Widgets/InfoBox/*.*
      - ./build/cesium/Widgets/NavigationHelpButton/*.*
      - ./build/cesium/Widgets/PerformanceWatchdog/*.*
      - ./build/cesium/Widgets/ProjectionPicker/*.*
      - ./build/cesium/Widgets/SceneModePicker/*.*
      - ./build/cesium/Widgets/SelectionIndicator/*.*
      - ./build/cesium/Widgets/Timeline/*.*
      - ./build/cesium/Widgets/Viewer/*.*
      - ./build/cesium/Widgets/VRButton/*.*
      - ./build/cesium/Workers/*.*

deploy-qa-11:
  stage: deploy
  <<: *base-dev
  cache: {}
  script:
    - echo Deploying to QA environment...
    - 'echo ========= Deploy: 11 (remote) ========='
    - xcopy /E /C /I /Q /H /R /Y build \\172.16.97.11\c$\%deployDir%
    - xcopy /E /C /I /Q /H /R /Y index.json \\172.16.97.11\e$\maps
  after_script:
    - C:\Production\Version\curl-win\bin\curl.exe -s -X POST %TELEGRAM_URL% -d chat_id=%CHAT_ID% -d text=" %CI_PROJECT_NAME% %CI_JOB_NAME% Success"


deploy-self(17):
  stage: deploy
  <<: *base-dev
  cache: {}
  script:
    - 'echo ========= Deploy: 17 (local) ========='
    - rmdir /s /q C:\%deployDir%
    - xcopy /E /C /I /Q /H /R /Y build C:\%deployDir%
    - xcopy /E /C /I /Q /H /R /Y index.json e:\maps
    - echo Done
  after_script:
    - C:\Production\Version\curl-win\bin\curl.exe -s -X POST %TELEGRAM_URL% -d chat_id=%CHAT_ID% -d text=" %CI_PROJECT_NAME% %CI_JOB_NAME% Success"

Increment_dzvin_dev:
  stage: increment-dzvin
  <<: *base-dev
  script:
    - echo run build
    - echo Done
    - cd C:\Version-dev\install_update
    - git checkout develop
    - git pull
    - powershell.exe .\Versionalyze_dev.ps1
    - powershell.exe Start-sleep -s 10
    - git commit -a -m "autocommit"
    - git push https://%PUSH_USER%:%PUSH_TOKEN%@%push_version% HEAD:develop
  dependencies: []

######################### START MASTER ##############################

build-master:
  stage: build
  <<: *base
  before_script:
    - C:\Production\Version\curl-win\bin\curl.exe -s -X POST %TELEGRAM_URL% -d chat_id=%CHAT_ID% -d text="Pipe Start %CI_PROJECT_NAME% with %CI_COMMIT_MESSAGE% by %GITLAB_USER_LOGIN% on %CI_COMMIT_REF_NAME%"
  script:
    - echo Building project...
    - call yarn --network-concurrency 1
    - call yarn add @DZVIN/CommonComponents @DZVIN/MilSymbolEditor --network-concurrency 1
    - copy .env .env.backup
    - copy .env.production .env
    - call npm run-script build
    - rmdir /s /q build\explorerLite
    - echo Done
  after_script:
    - C:\Production\Version\curl-win\bin\curl.exe -s -X POST %TELEGRAM_URL% -d chat_id=%CHAT_ID% -d text=" %CI_PROJECT_NAME% %CI_JOB_NAME% Success"
  artifacts:
    expire_in: 1 hour
    paths:
      - ./build/index.html
      - ./build/manifest.json
      - ./build/favicon.ico
      - ./build/service-worker.js
      - ./build/asset-manifest.json
      - ./build/images/*.*
      - ./build/static/css/*.*
      - ./build/static/js/*.*
      - ./build/static/media/*.*
      - ./build/cesium/*.*
      - ./build/cesium/Assets/*.*
      - ./build/cesium/Assets/IAU2006_XYS/*.*
      - ./build/cesium/Assets/Images/*.*
      - ./build/cesium/Assets/Textures/*.*
      - ./build/cesium/Assets/Textures/LensFlare/*.*
      - ./build/cesium/Assets/Textures/maki/*.*
      - ./build/cesium/Assets/Textures/NaturalEarthII/*.*
      - ./build/cesium/Assets/Textures/NaturalEarthII/0/*.*
      - ./build/cesium/Assets/Textures/NaturalEarthII/0/0/*.*
      - ./build/cesium/Assets/Textures/NaturalEarthII/0/1/*.*
      - ./build/cesium/Assets/Textures/NaturalEarthII/1/*.*
      - ./build/cesium/Assets/Textures/NaturalEarthII/1/0/*.*
      - ./build/cesium/Assets/Textures/NaturalEarthII/1/1/*.*
      - ./build/cesium/Assets/Textures/NaturalEarthII/1/2/*.*
      - ./build/cesium/Assets/Textures/NaturalEarthII/1/3/*.*
      - ./build/cesium/Assets/Textures/NaturalEarthII/2/*.*
      - ./build/cesium/Assets/Textures/NaturalEarthII/2/0/*.*
      - ./build/cesium/Assets/Textures/NaturalEarthII/2/1/*.*
      - ./build/cesium/Assets/Textures/NaturalEarthII/2/2/*.*
      - ./build/cesium/Assets/Textures/NaturalEarthII/2/3/*.*
      - ./build/cesium/Assets/Textures/NaturalEarthII/2/4/*.*
      - ./build/cesium/Assets/Textures/NaturalEarthII/2/5/*.*
      - ./build/cesium/Assets/Textures/NaturalEarthII/2/6/*.*
      - ./build/cesium/Assets/Textures/NaturalEarthII/2/7/*.*
      - ./build/cesium/Assets/Textures/SkyBox/*.*
      - ./build/cesium/ThirdParty/*.*
      - ./build/cesium/ThirdParty/Workers/*.*
      - ./build/cesium/Widgets/*.*
      - ./build/cesium/Widgets/Animation/*.*
      - ./build/cesium/Widgets/BaseLayerPicker/*.*
      - ./build/cesium/Widgets/Cesium3DTilesInspector/*.*
      - ./build/cesium/Widgets/CesiumInspector/*.*
      - ./build/cesium/Widgets/CesiumWidget/*.*
      - ./build/cesium/Widgets/FullscreenButton/*.*
      - ./build/cesium/Widgets/Geocoder/*.*
      - ./build/cesium/Widgets/Images/*.*
      - ./build/cesium/Widgets/Images/ImageryProviders/*.*
      - ./build/cesium/Widgets/Images/NavigationHelp/*.*
      - ./build/cesium/Widgets/Images/TerrainProviders/*.*
      - ./build/cesium/Widgets/InfoBox/*.*
      - ./build/cesium/Widgets/NavigationHelpButton/*.*
      - ./build/cesium/Widgets/PerformanceWatchdog/*.*
      - ./build/cesium/Widgets/ProjectionPicker/*.*
      - ./build/cesium/Widgets/SceneModePicker/*.*
      - ./build/cesium/Widgets/SelectionIndicator/*.*
      - ./build/cesium/Widgets/Timeline/*.*
      - ./build/cesium/Widgets/Viewer/*.*
      - ./build/cesium/Widgets/VRButton/*.*
      - ./build/cesium/Workers/*.*

deploy-qa29:
  stage: deploy
  <<: *base
  cache: {}
  script:
    - echo Deploying to QA environment...
    - 'echo ========= Deploy: 29 (remote) ========='
    - xcopy /E /C /I /Q /H /R /Y build \\172.16.97.29\c$\%deployDir%
    - xcopy /E /C /I /Q /H /R /Y index.json \\172.16.97.29\e$\maps
  after_script:
    - C:\Production\Version\curl-win\bin\curl.exe -s -X POST %TELEGRAM_URL% -d chat_id=%CHAT_ID% -d text=" %CI_PROJECT_NAME% %CI_JOB_NAME% Success"

#
deploy-qa43:
  stage: deploy
  <<: *base
  cache: {}
  script:
    - echo Deploying to QA environment...
    - 'echo ========= Deploy: 43 (remote) ========='
    - xcopy /E /C /I /Q /H /R /Y build \\172.16.97.43\c$\%deployDir%
    - xcopy /E /C /I /Q /H /R /Y index.json \\172.16.97.43\e$\maps
  after_script:
    - C:\Production\Version\curl-win\bin\curl.exe -s -X POST %TELEGRAM_URL% -d chat_id=%CHAT_ID% -d text=" %CI_PROJECT_NAME% %CI_JOB_NAME% Success"

deploy-zip:
  stage: deploy
  <<: *base
  script:
    - echo Packing bundle into ZIP file...
    - set jsonfile=package.json
    - set psCmd="add-type -As System.Web.Extensions;$JSON = new-object Web.Script.Serialization.JavaScriptSerializer;$JSON.DeserializeObject($input).version"
    - for /f %%I in ('^<"%jsonfile%" powershell -noprofile %psCmd%') do set "version=%%I"
    - 'echo Version: %version%'
    - set pack="WebmapFrontend_v%version%.zip"
    - echo %pack%
    - del /Q build\static\css\*.map
    - del /Q build\static\js\*.map
    - copy index.json .\build
    - cd build
    - echo Zipping...
    - '"%exe7z%" a -tzip "%releaseDir%\%pack%" "*"'
    - echo "copy to remote"
    - call pscp -batch -pw %SSH_PASS% %releaseDir%\WebmapFrontend_v%version%.zip %SSH_USER_HOST%:%REMOTE_PATH%/%CURRENT_VERSION_MASTER%/
  after_script:
    - C:\Production\Version\curl-win\bin\curl.exe -s -X POST %TELEGRAM_URL% -d chat_id=%CHAT_ID% -d text=" %CI_PROJECT_NAME% %CI_JOB_NAME% Success"

Increment_dzvin:
  stage: increment-dzvin
  <<: *base
  script:
    - echo run increment
    - echo Done
    - cd c:\Production\Version\install_update
    - git checkout master
    - git pull
    - powershell.exe .\Versionalyze.ps1
    - powershell.exe Start-sleep -s 10
    - git commit -a -m "autocommit"
    - git push https://%PUSH_USER%:%PUSH_TOKEN%@%push_version% HEAD:master
  dependencies: []
